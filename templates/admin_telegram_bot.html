
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة بوت التليجرام - لوحة الإدارة</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Cairo', sans-serif;
        }
        .main-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin: 20px 0;
        }
        .btn-admin {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            border-radius: 25px;
            padding: 10px 25px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .btn-admin:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
            color: white;
        }
        .status-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
        }
        .status-connected {
            background-color: #d4edda;
            color: #155724;
        }
        .status-disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
        .telegram-id {
            font-family: 'Courier New', monospace;
            background: #f8f9fa;
            padding: 5px 10px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="row">
            <!-- الشريط الجانبي -->
            <div class="col-md-3">
                <div class="main-container p-4">
                    <h5 class="mb-4"><i class="bi bi-gear"></i> لوحة الإدارة</h5>
                    <div class="list-group list-group-flush">
                        <a href="{{ url_for('admin_dashboard') }}" class="list-group-item list-group-item-action">
                            <i class="bi bi-speedometer2"></i> الرئيسية
                        </a>
                        <a href="{{ url_for('admin_stores') }}" class="list-group-item list-group-item-action">
                            <i class="bi bi-shop"></i> المحلات
                        </a>
                        <a href="{{ url_for('admin_users') }}" class="list-group-item list-group-item-action">
                            <i class="bi bi-people"></i> المستخدمين
                        </a>
                        <a href="{{ url_for('admin_telegram_bot') }}" class="list-group-item list-group-item-action active">
                            <i class="bi bi-telegram"></i> بوت التليجرام
                        </a>
                        <a href="{{ url_for('admin_settings') }}" class="list-group-item list-group-item-action">
                            <i class="bi bi-gear"></i> الإعدادات
                        </a>
                        <div class="dropdown-divider"></div>
                        <a href="{{ url_for('index') }}" class="list-group-item list-group-item-action">
                            <i class="bi bi-house"></i> العودة للموقع
                        </a>
                    </div>
                </div>
            </div>

            <!-- المحتوى الرئيسي -->
            <div class="col-md-9">
                <div class="main-container p-4">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3><i class="bi bi-telegram"></i> إدارة بوت التليجرام</h3>
                    </div>

                    <!-- إدارة التوكن -->
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5><i class="bi bi-key"></i> إدارة توكن البوت</h5>
                            <button class="btn btn-admin btn-sm" onclick="toggleTokenForm()">
                                <i class="bi bi-gear"></i> إدارة التوكن
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="tokenDisplay">
                                <p><strong>التوكن الحالي:</strong> 
                                    <span id="currentToken" class="font-monospace text-muted">جاري التحميل...</span>
                                </p>
                            </div>
                            
                            <div id="tokenForm" class="d-none">
                                <div class="mb-3">
                                    <label class="form-label">توكن بوت التليجرام</label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="tokenInput" placeholder="أدخل توكن البوت">
                                        <button class="btn btn-outline-secondary" type="button" onclick="toggleTokenVisibility()">
                                            <i class="bi bi-eye" id="tokenToggleIcon"></i>
                                        </button>
                                    </div>
                                    <small class="form-text text-muted">
                                        احصل على التوكن من <a href="https://t.me/BotFather" target="_blank">@BotFather</a>
                                    </small>
                                </div>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-primary" onclick="saveToken()">
                                        <i class="bi bi-check"></i> حفظ التوكن
                                    </button>
                                    <button class="btn btn-danger" onclick="deleteToken()">
                                        <i class="bi bi-trash"></i> حذف التوكن
                                    </button>
                                    <button class="btn btn-secondary" onclick="toggleTokenForm()">
                                        <i class="bi bi-x"></i> إلغاء
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- حالة البوت -->
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5><i class="bi bi-info-circle"></i> حالة البوت</h5>
                            <div>
                                <button id="refreshStatusBtn" class="btn btn-outline-secondary btn-sm me-2" onclick="refreshBotStatus()">
                                    <i class="bi bi-arrow-clockwise"></i> تحديث الحالة
                                </button>
                                <button id="reconnectBtn" class="btn btn-admin btn-sm" onclick="reconnectBot()">
                                    <i class="bi bi-arrow-repeat"></i> إعادة الاتصال
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>التوكن:</strong> 
                                        <span id="tokenStatus" class="status-badge {{ 'status-connected' if bot_token_exists else 'status-disconnected' }}">
                                            {{ 'موجود' if bot_token_exists else 'غير موجود' }}
                                        </span>
                                    </p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>حالة الاتصال:</strong> 
                                        <span id="connectionStatus" class="status-badge {{ 'status-connected' if bot_status == 'متصل' else 'status-disconnected' }}">
                                            {{ bot_status }}
                                        </span>
                                    </p>
                                </div>
                            </div>
                            
                            <div id="statusAlert" class="alert d-none">
                                <i class="bi bi-info-circle"></i>
                                <span id="statusMessage"></span>
                            </div>
                            
                            <div id="tokenWarning" class="alert alert-warning {{ 'd-none' if bot_token_exists else '' }}">
                                <i class="bi bi-exclamation-triangle"></i>
                                <strong>تنبيه:</strong> يجب إضافة التوكن من خلال "إدارة التوكن" أعلاه أو عبر Secrets
                            </div>
                            
                            <div id="disconnectedWarning" class="alert alert-info {{ 'd-none' if bot_status == 'متصل' else '' }}">
                                <i class="bi bi-wifi-off"></i>
                                <strong>ملاحظة:</strong> البوت غير متصل حالياً. استخدم زر "إعادة الاتصال" لمحاولة الاتصال مرة أخرى.
                            </div>
                        </div>
                    </div>

                    <!-- إدارة المديرين -->
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5><i class="bi bi-people-fill"></i> المديرين المخولين</h5>
                            <button type="button" class="btn btn-admin" data-bs-toggle="modal" data-bs-target="#addAdminModal">
                                <i class="bi bi-plus"></i> إضافة مدير
                            </button>
                        </div>
                        <div class="card-body">
                            {% if admin_telegram_ids %}
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>معرف التليجرام</th>
                                            <th>اسم المدير</th>
                                            <th>تاريخ الإضافة</th>
                                            <th>الإجراءات</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for admin in admin_telegram_ids %}
                                        <tr>
                                            <td><span class="telegram-id">{{ admin[1] }}</span></td>
                                            <td>{{ admin[2] or 'غير محدد' }}</td>
                                            <td>{{ admin[3][:19] if admin[3] else 'غير محدد' }}</td>
                                            <td>
                                                <a href="{{ url_for('delete_telegram_admin', admin_id=admin[0]) }}" 
                                                   class="btn btn-sm btn-outline-danger"
                                                   onclick="return confirm('هل أنت متأكد من حذف هذا المدير؟')">
                                                    <i class="bi bi-trash"></i> حذف
                                                </a>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <div class="text-center py-4">
                                <i class="bi bi-people" style="font-size: 3rem; color: #ccc;"></i>
                                <h5 class="mt-3 text-muted">لا يوجد مديرين مضافين</h5>
                                <p class="text-muted">أضف معرف التليجرام الخاص بك للبدء</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- تعليمات الاستخدام -->
                    <div class="card mt-4">
                        <div class="card-header">
                            <h5><i class="bi bi-question-circle"></i> كيفية الاستخدام</h5>
                        </div>
                        <div class="card-body">
                            <ol>
                                <li><strong>إنشاء البوت:</strong> توجه إلى <a href="https://t.me/BotFather" target="_blank">@BotFather</a> على التليجرام وأنشئ بوت جديد</li>
                                <li><strong>الحصول على التوكن:</strong> انسخ التوكن الذي سيرسله لك BotFather</li>
                                <li><strong>إضافة التوكن:</strong> اذهب إلى صفحة Secrets وأضف التوكن باسم <code>TELEGRAM_BOT_TOKEN</code></li>
                                <li><strong>إضافة معرفك:</strong> أضف معرف التليجرام الخاص بك في القائمة أعلاه</li>
                                <li><strong>بدء البوت:</strong> ابحث عن البوت في التليجرام وأرسل <code>/start</code></li>
                            </ol>
                            <div class="alert alert-info mt-3">
                                <i class="bi bi-lightbulb"></i>
                                <strong>نصيحة:</strong> للحصول على معرف التليجرام الخاص بك، أرسل رسالة لـ <a href="https://t.me/userinfobot" target="_blank">@userinfobot</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal إضافة مدير -->
    <div class="modal fade" id="addAdminModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">إضافة مدير جديد</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" action="{{ url_for('add_telegram_admin') }}">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">معرف التليجرام <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="telegram_id" required 
                                   placeholder="مثال: 123456789">
                            <small class="form-text text-muted">
                                للحصول على معرفك، أرسل رسالة لـ @userinfobot
                            </small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">اسم المدير (اختياري)</label>
                            <input type="text" class="form-control" name="admin_name" 
                                   placeholder="اسم المدير للتمييز">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                        <button type="submit" class="btn btn-admin">إضافة المدير</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // تحميل التوكن المحفوظ عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            loadSavedToken();
        });

        // تحميل التوكن المحفوظ
        async function loadSavedToken() {
            try {
                const response = await fetch('/api/get-telegram-token');
                const data = await response.json();
                
                const currentTokenSpan = document.getElementById('currentToken');
                if (data.has_token) {
                    currentTokenSpan.textContent = data.token;
                    currentTokenSpan.className = 'font-monospace text-success';
                } else {
                    currentTokenSpan.textContent = 'لم يتم إضافة توكن';
                    currentTokenSpan.className = 'font-monospace text-muted';
                }
            } catch (error) {
                console.error('خطأ في تحميل التوكن:', error);
            }
        }

        // إظهار/إخفاء نموذج التوكن
        function toggleTokenForm() {
            const tokenDisplay = document.getElementById('tokenDisplay');
            const tokenForm = document.getElementById('tokenForm');
            
            if (tokenForm.classList.contains('d-none')) {
                tokenDisplay.classList.add('d-none');
                tokenForm.classList.remove('d-none');
            } else {
                tokenDisplay.classList.remove('d-none');
                tokenForm.classList.add('d-none');
                document.getElementById('tokenInput').value = '';
            }
        }

        // إظهار/إخفاء التوكن
        function toggleTokenVisibility() {
            const tokenInput = document.getElementById('tokenInput');
            const toggleIcon = document.getElementById('tokenToggleIcon');
            
            if (tokenInput.type === 'password') {
                tokenInput.type = 'text';
                toggleIcon.className = 'bi bi-eye-slash';
            } else {
                tokenInput.type = 'password';
                toggleIcon.className = 'bi bi-eye';
            }
        }

        // حفظ التوكن
        async function saveToken() {
            const token = document.getElementById('tokenInput').value.trim();
            
            if (!token) {
                showStatusMessage('يرجى إدخال التوكن', 'warning');
                return;
            }
            
            try {
                const response = await fetch('/admin/save-telegram-token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ token: token })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showStatusMessage(data.message, 'success');
                    toggleTokenForm();
                    loadSavedToken();
                    setTimeout(refreshBotStatus, 1000);
                } else {
                    showStatusMessage(data.message, 'danger');
                }
                
            } catch (error) {
                showStatusMessage('خطأ في الاتصال بالخادم', 'danger');
                console.error('Error saving token:', error);
            }
        }

        // حذف التوكن
        async function deleteToken() {
            if (!confirm('هل أنت متأكد من حذف التوكن؟ سيتم قطع الاتصال مع البوت.')) {
                return;
            }
            
            try {
                const response = await fetch('/admin/delete-telegram-token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showStatusMessage(data.message, 'success');
                    toggleTokenForm();
                    loadSavedToken();
                    setTimeout(refreshBotStatus, 1000);
                } else {
                    showStatusMessage(data.message, 'danger');
                }
                
            } catch (error) {
                showStatusMessage('خطأ في الاتصال بالخادم', 'danger');
                console.error('Error deleting token:', error);
            }
        }

        // تحديث حالة البوت
        async function refreshBotStatus() {
            const refreshBtn = document.getElementById('refreshStatusBtn');
            const originalHtml = refreshBtn.innerHTML;
            
            refreshBtn.innerHTML = '<i class="bi bi-arrow-clockwise spin"></i> جاري التحديث...';
            refreshBtn.disabled = true;
            
            try {
                const response = await fetch('/api/telegram-bot-status');
                const data = await response.json();
                
                if (data.error) {
                    showStatusMessage('خطأ في جلب الحالة', 'danger');
                    return;
                }
                
                // تحديث عرض التوكن
                const tokenStatus = document.getElementById('tokenStatus');
                tokenStatus.className = `status-badge ${data.token_exists ? 'status-connected' : 'status-disconnected'}`;
                tokenStatus.textContent = data.token_exists ? 'موجود' : 'غير موجود';
                
                // تحديث حالة الاتصال
                const connectionStatus = document.getElementById('connectionStatus');
                connectionStatus.className = `status-badge ${data.connected ? 'status-connected' : 'status-disconnected'}`;
                connectionStatus.textContent = data.status;
                
                // إظهار/إخفاء التحذيرات
                const tokenWarning = document.getElementById('tokenWarning');
                tokenWarning.className = `alert alert-warning ${data.token_exists ? 'd-none' : ''}`;
                
                const disconnectedWarning = document.getElementById('disconnectedWarning');
                disconnectedWarning.className = `alert alert-info ${data.connected ? 'd-none' : ''}`;
                
                showStatusMessage('تم تحديث الحالة بنجاح', 'success');
                
            } catch (error) {
                showStatusMessage('خطأ في الاتصال بالخادم', 'danger');
                console.error('Error refreshing status:', error);
            } finally {
                refreshBtn.innerHTML = originalHtml;
                refreshBtn.disabled = false;
            }
        }
        
        // إعادة الاتصال بالبوت
        async function reconnectBot() {
            const reconnectBtn = document.getElementById('reconnectBtn');
            const originalHtml = reconnectBtn.innerHTML;
            
            reconnectBtn.innerHTML = '<i class="bi bi-arrow-repeat spin"></i> جاري الاتصال...';
            reconnectBtn.disabled = true;
            
            try {
                const response = await fetch('/admin/reconnect-telegram-bot', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showStatusMessage(data.message, 'success');
                    // تحديث الحالة تلقائياً بعد الاتصال
                    setTimeout(refreshBotStatus, 1000);
                } else {
                    showStatusMessage(data.message, 'danger');
                }
                
            } catch (error) {
                showStatusMessage('خطأ في الاتصال بالخادم', 'danger');
                console.error('Error reconnecting bot:', error);
            } finally {
                reconnectBtn.innerHTML = originalHtml;
                reconnectBtn.disabled = false;
            }
        }
        
        // عرض رسائل الحالة
        function showStatusMessage(message, type) {
            const alert = document.getElementById('statusAlert');
            const messageSpan = document.getElementById('statusMessage');
            
            alert.className = `alert alert-${type}`;
            messageSpan.textContent = message;
            
            // إزالة الفئة d-none لإظهار الرسالة
            alert.classList.remove('d-none');
            
            // إخفاء الرسالة بعد 5 ثوان
            setTimeout(() => {
                alert.classList.add('d-none');
            }, 5000);
        }
        
        // تحديث الحالة تلقائياً كل 30 ثانية
        setInterval(refreshBotStatus, 30000);
        
        // CSS للحركة الدوارة
        const style = document.createElement('style');
        style.textContent = `
            .spin {
                animation: spin 1s linear infinite;
            }
            @keyframes spin {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
