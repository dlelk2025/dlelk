{% extends "admin_dashboard.html" %}

{% block title %}إدارة الكوبونات - لوحة الإدارة{% endblock %}

{% block content %}
<div class="container-fluid p-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-ticket-perforated"></i> إدارة الكوبونات</h2>
        <button class="btn btn-primary" data-bs-toggle="collapse" data-bs-target="#addCouponForm">
            <i class="bi bi-plus-circle"></i> إضافة كوبون جديد
        </button>
    </div>

    <!-- الإحصائيات -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h5>الكوبونات النشطة</h5>
                    <h2>{{ stats.active_coupons }}</h2>
                    <small>كوبون نشط</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body">
                    <h5>الكوبونات المنتهية</h5>
                    <h2>{{ stats.expired_coupons }}</h2>
                    <small>كوبون منتهي</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h5>إجمالي الاستخدامات</h5>
                    <h2>{{ stats.total_uses }}</h2>
                    <small>استخدام</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-dark">
                <div class="card-body">
                    <h5>النقاط الممنوحة</h5>
                    <h2>{{ stats.total_points_awarded }}</h2>
                    <small>نقطة</small>
                </div>
            </div>
        </div>
    </div>

    <!-- نموذج إضافة كوبون -->
    <div class="collapse mb-4" id="addCouponForm">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-plus-circle"></i> إضافة كوبون جديد</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('add_coupon') }}">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">اسم الكوبون <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" name="name" required 
                                       placeholder="مثال: كوبون الترحيب">
                                <div class="form-text">اسم وصفي للكوبون</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">كود الكوبون <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" name="code" required 
                                       placeholder="مثال: WELCOME2024" style="text-transform: uppercase;">
                                <div class="form-text">الكود الذي سيستخدمه المستخدمون</div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">عدد النقاط <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" name="points" min="1" required>
                                <div class="form-text">النقاط التي سيحصل عليها المستخدم</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">عدد الاستخدامات <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" name="max_uses" min="1" required>
                                <div class="form-text">عدد المستخدمين الذين يمكنهم استخدام الكوبون</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">تاريخ الانتهاء <span class="text-danger">*</span></label>
                                <input type="datetime-local" class="form-control" name="expires_at" required>
                                <div class="form-text">متى ينتهي الكوبون</div>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">وصف الكوبون</label>
                        <textarea class="form-control" name="description" rows="2" placeholder="وصف اختياري للكوبون"></textarea>
                    </div>
                    <div class="d-flex justify-content-between">
                        <button type="button" class="btn btn-secondary" data-bs-toggle="collapse" data-bs-target="#addCouponForm">
                            إلغاء
                        </button>
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-check-circle"></i> إضافة الكوبون
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- قائمة الكوبونات -->
    <div class="card">
        <div class="card-header">
            <h5><i class="bi bi-list"></i> جميع الكوبونات</h5>
        </div>
        <div class="card-body">
            {% if coupons %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>اسم الكوبون</th>
                            <th>الكود</th>
                            <th>النقاط</th>
                            <th>الاستخدامات</th>
                            <th>تاريخ الانتهاء</th>
                            <th>الحالة</th>
                            <th>المنشئ</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for coupon in coupons %}
                        <tr>
                            <td>
                                <a href="{{ url_for('admin_coupon_details', coupon_id=coupon[0]) }}" 
                                   class="text-decoration-none fw-bold">
                                    {{ coupon[1] }}
                                </a>
                            </td>
                            <td>
                                <code class="bg-light px-2 py-1 rounded">{{ coupon[2] }}</code>
                            </td>
                            <td>
                                <span class="badge bg-warning text-dark">{{ coupon[3] }} نقطة</span>
                            </td>
                            <td>
                                <span class="text-muted">{{ coupon[5] }}</span> / {{ coupon[4] }}
                                {% if coupon[5] >= coupon[4] %}
                                    <i class="bi bi-check-circle-fill text-success ms-1" title="مكتمل"></i>
                                {% endif %}
                            </td>
                            <td>
                                <small class="text-muted">{{ coupon[6] }}</small>
                                {% if coupon[6] %}
                                    <br><span class="badge bg-danger coupon-expired" data-expires="{{ coupon[6] }}">منتهي</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge bg-{{ 'success' if coupon[7] else 'secondary' }}">
                                    {{ 'نشط' if coupon[7] else 'معطل' }}
                                </span>
                            </td>
                            <td>{{ coupon[11] or 'غير محدد' }}</td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <a href="{{ url_for('admin_coupon_details', coupon_id=coupon[0]) }}" 
                                       class="btn btn-outline-info" title="التفاصيل">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    <a href="{{ url_for('toggle_coupon', coupon_id=coupon[0]) }}" 
                                       class="btn btn-outline-{{ 'warning' if coupon[7] else 'success' }}" 
                                       title="{{ 'تعطيل' if coupon[7] else 'تفعيل' }}">
                                        <i class="bi bi-{{ 'pause' if coupon[7] else 'play' }}"></i>
                                    </a>
                                    <button class="btn btn-outline-danger" 
                                            onclick="deleteCoupon({{ coupon[0] }}, '{{ coupon[1] }}')" 
                                            title="حذف">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="bi bi-ticket-perforated display-1 text-muted mb-3"></i>
                <h4 class="text-muted">لا توجد كوبونات بعد</h4>
                <p class="text-muted">أضف كوبونات جديدة لتحفيز المستخدمين على المشاركة</p>
                <button class="btn btn-primary" data-bs-toggle="collapse" data-bs-target="#addCouponForm">
                    <i class="bi bi-plus-circle"></i> إضافة أول كوبون
                </button>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
function deleteCoupon(id, name) {
    if (confirm(`هل تريد حذف الكوبون "${name}"؟\n\nتحذير: سيتم حذف جميع سجلات الاستخدام المرتبطة به.`)) {
        window.location.href = `/admin/delete-coupon/${id}`;
    }
}

// تحويل كود الكوبون إلى أحرف كبيرة تلقائياً
document.querySelector('input[name="code"]').addEventListener('input', function() {
    this.value = this.value.toUpperCase();
});

// تعيين الحد الأدنى لتاريخ الانتهاء (الآن + 1 ساعة)
document.addEventListener('DOMContentLoaded', function() {
    const expiresAtInput = document.querySelector('input[name="expires_at"]');
    if (expiresAtInput) {
        const now = new Date();
        now.setHours(now.getHours() + 4); // +3 لتوقيت دمشق +1 كحد أدنى
        const minDateTime = now.toISOString().slice(0, 16);
        expiresAtInput.min = minDateTime;
    }

    // التحقق من انتهاء صلاحية الكوبونات
    const expiredBadges = document.querySelectorAll('.coupon-expired');
    const now = new Date();
    // إضافة 3 ساعات لتوقيت دمشق
    now.setHours(now.getHours() + 3);
    const currentTime = now.toISOString().slice(0, 19).replace('T', ' ');

    expiredBadges.forEach(function(badge) {
        const expiresAt = badge.getAttribute('data-expires');
        if (expiresAt && expiresAt <= currentTime) {
            badge.style.display = 'inline-block';
        } else {
            badge.style.display = 'none';
        }
    });
});
</script>

<style>
.table td {
    vertical-align: middle;
}

.badge {
    font-size: 0.8em;
}

code {
    font-size: 0.9em;
}

.btn-group-sm .btn {
    padding: 0.25rem 0.5rem;
}

.coupon-expired {
    display: none;
}
</style>
{% endblock %}